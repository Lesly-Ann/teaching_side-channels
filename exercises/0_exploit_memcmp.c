#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

#include "cacheutils.h"
#include "0_victim_memcmp.h"

#define NUM_SAMPLES     100

static uint64_t times[NUM_SAMPLES];

int main()
{
    char *pwd;
    int j, allowed = 0;
    uint64_t tsc1, tsc2, med;

    victim_init();

    while ((pwd = read_from_user()) && strcmp(pwd, "q"))
    {
        int user_len = strlen(pwd);

        /* BEGIN_SOLUTION */
        /* collect execution timing samples */
        for (j = 0; j < NUM_SAMPLES; j++) {
            tsc1 = rdtsc_begin();
        /* END_SOLUTION */
            allowed = check_pwd(pwd, user_len);
        /* BEGIN_SOLUTION */
            tsc2 = rdtsc_end();
            times[j] = tsc2 - tsc1;
        }

        /* compute median over all samples (avg may be affected by outliers) */
        compute_median(times, NUM_SAMPLES, &med);
        printf("time (med clock cycles): %lu\n", med);
        /* END_SOLUTION */


        if (allowed) {
            print_success_art();
            free(pwd);
            break;
        } else {
            printf("ACCESS DENIED\n");
        }
        free(pwd);
    }

    return 0;
}